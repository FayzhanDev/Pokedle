<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokeGuessr</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="icon" type="image/png" href="assets/images/pokeball.png">
    <link rel="apple-touch-icon" href="assets/images/pokeball.png">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header>
        <a href="javascript:location.reload()">
            <img class="Titre" src="assets/images/PokeGuessr.png" alt="Logo PokeGuessr">
        </a>
        <div id="soustitre-accueil" class="sous-titre">
            <h2>Tous les jours, devine un Pokemon !</h2>
        </div>
    </header>

    <main id="page-content">
        <div id="menu-principal" class="menu-vertical">
            <div class="card">
                <h2>CLASSIQUE</h2>
                <button class="button" onclick="changerMenu('classique')">
                    <img src="assets/images/zarbi" alt="Zarbi">
                    <span>Toutes les g√©n√©rations</span>
                </button>
            </div>
            <div class="card">
                <h2>CARTE</h2>
                <button class="button" onclick="changerMenu('carte')">
                    <img src="assets/images/zarbi2.png" alt="Zarbi2">
                    <span>Avec une carte flout√©e</span>
                </button>
            </div>
            <div class="card">
                <h2>DESCRIPTION</h2>
                <button class="button" onclick="changerMenu('description')">
                    <img src="assets/images/salameche.png" alt="Salameche">
                    <span>Indices du Pok√©dex</span>
                </button>
            </div>
            <div class="card">
                <h2>OMBRE</h2>
                <button class="button" onclick="changerMenu('ombre')">
                    <img src="assets/images/ombre.png" alt="Ombre">
                    <span>Devine la silhouette</span>
                </button>
            </div>
        </div>

        <div id="zone-jeu" class="hidden">
            <h2 id="titre-mode" style="text-align: center; color: white; text-shadow: 2px 2px black;"></h2>
            
            <div id="contenu-dynamique-du-jeu"></div>

            <div id="devinette-container" class="menu-vertical hidden" style="margin-top: 20px;">
                <div id="win-streak-container">
                    SERIE : <span id="streak-count">0</span> üî•
                </div>

                <div id="compteur-essais" style="color: #FFCB05; font-weight: bold; margin-bottom: 10px; font-size: 1.2rem; text-shadow: 1px 1px black;">
                    ESSAIS : 0
                </div>

                <input type="text" id="input-pokemon" placeholder="Nom du Pok√©mon..." 
                       style="padding: 10px; border-radius: 10px; border: 2px solid #2f4f2f; font-family: Arial, sans-serif; width: 250px; text-align: center; font-size: 16px;">
                
                <button id="btn-valider" class="button" onclick="verifierReponse()" style="width: 200px; background: #FFCB05; color: #3b4cca; margin-top: 10px;">
                    VALIDER
                </button>

                <button id="btn-reveler" class="button" onclick="revelerPokemon()" style="width: 200px; background: #ff4d4d; color: white; margin-top: 5px; font-size: 0.8rem;">
                    REVELER LE POKEMON
                </button>

                <button id="btn-rejouer" class="button hidden" onclick="chargerNouveauPokemon()" style="width: 200px; background: #6ddc8c; color: white; margin-top: 5px;">
                    REJOUER
                </button>
                
                <p id="message-retour" style="color: white; font-weight: bold; text-shadow: 1px 1px black; min-height: 25px; text-align: center; margin-top: 10px;"></p>
            </div>

            <button class="button" id="btn-retour-style" onclick="retourMenu()" style="margin-top: 30px;">
                RETOUR AU MENU
            </button>
        </div>
    </main>

    <footer>
        <p>PokeGuessr.net - 2025</p>
        <div class="social-links">
            <a href="https://www.instagram.com/iblamegaetan/"><img src="assets/images/insta.png" alt="Instagram"></a>
            <a href="https://www.youtube.com/@fayzhan5977"><img src="assets/images/youtube.png" alt="YouTube"></a>
            <a href="https://github.com/FayzhanDev"><img src="assets/images/github.png" alt="GitHub"></a>
        </div>
        <p>Developpeur : Gaetan Demoy</p>
    </footer>


<script>
let pokemonATrouver = "";
let nomAffichage = ""; 
let modeActuel = "";
let flouActuel = 20;
let essais = 0;
let fini = false;

let winStreak = localStorage.getItem("pokemonStreak") || 0;

function updateStreakDisplay() {
    document.getElementById('streak-count').innerText = winStreak;
    document.getElementById('win-streak-container').style.opacity = (winStreak > 0) ? "1" : "0.3";
}

function simplifierTexte(texte) {
    if (!texte) return "";
    return texte.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "").trim();
}

function enleverAccentsAffichage(texte) {
    if (!texte) return "";
    return texte.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
}

async function changerMenu(mode) {
    modeActuel = mode;
    document.getElementById('menu-principal').classList.add('hidden');
    document.getElementById('soustitre-accueil').classList.add('hidden');
    document.getElementById('zone-jeu').classList.remove('hidden');
    document.getElementById('titre-mode').innerText = "MODE " + mode.toUpperCase();
    updateStreakDisplay();
    await chargerNouveauPokemon();
}

async function chargerNouveauPokemon() {
    flouActuel = 20;
    essais = 0;
    fini = false;
    document.getElementById('compteur-essais').innerText = "ESSAIS : 0";
    document.getElementById('message-retour').innerText = "";
    document.getElementById('input-pokemon').value = "";
    document.getElementById('input-pokemon').disabled = false;
    document.getElementById('btn-valider').classList.remove('hidden');
    document.getElementById('btn-reveler').classList.remove('hidden');
    document.getElementById('btn-rejouer').classList.add('hidden');
    document.getElementById('devinette-container').classList.remove('hidden');
    updateStreakDisplay();

    const conteneur = document.getElementById('contenu-dynamique-du-jeu');
    conteneur.innerHTML = '<p style="color: white;">CHARGEMENT...</p>';

    try {
        if (modeActuel === 'classique') await chargerPokemonClassique();
        else if (modeActuel === 'carte') await chargerPokemonCarte();
        else if (modeActuel === 'description') await chargerPokemonDescription();
        else if (modeActuel === 'ombre') await chargerPokemonOmbre();
    } catch (e) {
        console.error(e);
        conteneur.innerHTML = '<p style="color: white;">ERREUR. REESSAYE.</p>';
    }
}

async function chargerPokemonClassique(estOmbre = false) {
    const idRandom = Math.floor(Math.random() * 1025) + 1;
    const resSpecies = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${idRandom}`);
    const dataSpecies = await resSpecies.json();
    const resBase = await fetch(`https://pokeapi.co/api/v2/pokemon/${idRandom}`);
    const dataBase = await resBase.json();

    const nomFrObj = dataSpecies.names.find(n => n.language.name === "fr");
    nomAffichage = nomFrObj ? nomFrObj.name : dataSpecies.name;
    pokemonATrouver = simplifierTexte(nomAffichage);

    const imageURL = dataBase.sprites.other['official-artwork'].front_default || dataBase.sprites.front_default;
    const styleFiltre = estOmbre ? "filter: brightness(0);" : "filter: brightness(1);";

    document.getElementById('contenu-dynamique-du-jeu').innerHTML = `
        <div style="text-align: center; margin: 20px;">
            <img id="image-pokemon" src="${imageURL}" style="width: 200px; ${styleFiltre}">
        </div>`;
}

async function chargerPokemonOmbre() { await chargerPokemonClassique(true); }

async function chargerPokemonCarte() {
    const idRandom = Math.floor(Math.random() * 1025) + 1;
    const resSpecies = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${idRandom}`);
    const dataSpecies = await resSpecies.json();
    
    const resCard = await fetch(`https://api.tcgdex.net/v2/fr/cards?name=${encodeURIComponent(dataSpecies.name)}`);
    const cardsData = await resCard.json();
    const validCards = cardsData.filter(c => c.image !== undefined);
    
    if (validCards.length === 0) return chargerPokemonCarte();

    const nomFrObj = dataSpecies.names.find(n => n.language.name === "fr");
    nomAffichage = nomFrObj ? nomFrObj.name : dataSpecies.name;
    pokemonATrouver = simplifierTexte(nomAffichage);

    const carte = validCards[Math.floor(Math.random() * validCards.length)];
    document.getElementById('contenu-dynamique-du-jeu').innerHTML = `
        <div style="text-align: center; margin: 20px;">
            <img id="image-pokemon" src="${carte.image}/high.webp" 
                 style="filter: blur(${flouActuel}px) brightness(0.8); width: 240px; border-radius:10px;">
        </div>`;
}

async function chargerPokemonDescription() {
    const idRandom = Math.floor(Math.random() * 1025) + 1;
    const resSpecies = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${idRandom}`);
    const dataSpecies = await resSpecies.json();
    const nomFrObj = dataSpecies.names.find(n => n.language.name === "fr");
    nomAffichage = nomFrObj ? nomFrObj.name : dataSpecies.name;
    pokemonATrouver = simplifierTexte(nomAffichage);

    const entriesFr = dataSpecies.flavor_text_entries.filter(e => e.language.name === "fr");
    let texte = entriesFr.length > 0 ? entriesFr[Math.floor(Math.random() * entriesFr.length)].flavor_text : "Pas de description disponible.";
    
    const regex = new RegExp(nomAffichage, "gi");
    let texteFinal = texte.replace(regex, "[ POKEMON ]").replace(/[\f\n\r]/g, ' ').normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();

    document.getElementById('contenu-dynamique-du-jeu').innerHTML = `
        <div class="card" id="image-pokemon" style="width: 85%; max-width: 400px; margin: 20px auto; background:#f9f6d8; border:4px solid #2f4f2f; padding:15px; box-shadow: 4px 4px 0px #2f4f2f;">
            <p style="font-size: 16px; color: #2f4f2f; font-family: Arial, sans-serif; line-height: 1.4; margin: 0;">"${texteFinal}"</p>
        </div>`;
}

function verifierReponse() {
    if(fini) return;
    const input = document.getElementById('input-pokemon');
    const saisie = simplifierTexte(input.value);
    const message = document.getElementById('message-retour');
    const image = document.getElementById('image-pokemon');

    if (saisie === pokemonATrouver) {
        lancerConfettis();
        gagner();
    } else {
        essais++;
        document.getElementById('compteur-essais').innerText = "ESSAIS : " + essais;
        if (modeActuel === 'carte' && image && flouActuel > 0) {
            flouActuel = Math.max(0, flouActuel - 4);
            image.style.filter = `blur(${flouActuel}px) brightness(0.8)`;
        }
        message.innerText = "CE N'EST PAS CA...";
        message.style.color = "#ff4d4d";
        input.value = "";
    }
}

function lancerConfettis() {
    confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 },
        colors: ['#FFCB05', '#3b4cca', '#ff4d4d', '#6ddc8c']
    });
}

function revelerPokemon() {
    const message = document.getElementById('message-retour');
    message.innerText = "C'ETAIT : " + enleverAccentsAffichage(nomAffichage);
    message.style.color = "#FFCB05";

    winStreak = 0;
    localStorage.setItem("pokemonStreak", 0);
    updateStreakDisplay();

    terminerPartie();
}

function gagner() {
    const message = document.getElementById('message-retour');
    message.innerText = "BRAVO ! C'EST BIEN " + enleverAccentsAffichage(nomAffichage);
    message.style.color = "#6ddc8c";

    winStreak = parseInt(winStreak) + 1;
    localStorage.setItem("pokemonStreak", winStreak);
    updateStreakDisplay();

    terminerPartie();
}

function terminerPartie() {
    fini = true;
    const image = document.getElementById('image-pokemon');
    if (image) {
        image.style.filter = "blur(0px) brightness(1)";
        image.classList.add('zoom-victoire');
    }
    
    document.getElementById('input-pokemon').disabled = true;
    document.getElementById('btn-valider').classList.add('hidden');
    document.getElementById('btn-reveler').classList.add('hidden');
    document.getElementById('btn-rejouer').classList.remove('hidden');
}

function retourMenu() {
    document.getElementById('menu-principal').classList.remove('hidden');
    document.getElementById('soustitre-accueil').classList.remove('hidden');
    document.getElementById('zone-jeu').classList.add('hidden');
}

document.getElementById('input-pokemon').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') verifierReponse();
});

updateStreakDisplay();
</script>
</body>
</html>